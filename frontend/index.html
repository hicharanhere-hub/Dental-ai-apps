<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DentalAI Pro - Advanced Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: #0f172a; color: white; }
        .glass { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        .gradient-text { background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .scan-line { animation: scan 3s linear infinite; }
        @keyframes scan { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .heatmap { mix-blend-mode: overlay; opacity: 0.6; pointer-events: none; }
        .confidence-bar { transition: width 1s ease-out; }
    </style>
</head>
<body class="min-h-screen">
    <!-- AI Provider Selection -->
    <div class="fixed top-0 w-full z-50 glass border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <span class="text-xl font-bold gradient-text">ðŸ¦· DentalAI Pro</span>
                <span class="px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded-full">v2.0</span>
            </div>
            <select id="aiProvider" class="bg-slate-800 border border-white/20 rounded-lg px-3 py-1 text-sm">
                <option value="mock">Demo Mode (No API)</option>
                <option value="openai">OpenAI GPT-4 Vision</option>
                <option value="google">Google Cloud Vision</option>
                <option value="pearl">Pearl AI (Enterprise)</option>
                <option value="custom">Custom API Endpoint</option>
            </select>
        </div>
    </div>

    <div class="pt-20 pb-8 px-4 max-w-7xl mx-auto">
        <!-- Upload Section -->
        <div id="uploadSection" class="max-w-2xl mx-auto text-center py-12">
            <div class="glass rounded-2xl p-8">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-blue-600/20 flex items-center justify-center">
                    <i class="fas fa-brain text-3xl text-blue-400">ðŸ§ </i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Advanced AI Analysis</h2>
                <p class="text-gray-400 mb-6">Multi-modal detection: Caries â€¢ Bone Loss â€¢ Lesions â€¢ Pathologies â€¢ Anatomy</p>
                
                <input type="file" id="fileInput" accept="image/*" class="hidden">
                <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 hover:bg-blue-700 px-8 py-4 rounded-xl w-full transition font-medium">
                    Upload X-Ray for AI Analysis
                </button>
                
                <div class="mt-4 flex justify-center space-x-4 text-xs text-gray-500">
                    <span>ðŸ”’ HIPAA Ready</span>
                    <span>âš¡ Real-time</span>
                    <span>ðŸ“Š PDF Reports</span>
                </div>
            </div>
        </div>

        <!-- Analysis Dashboard -->
        <div id="analysisDashboard" class="hidden space-y-6">
            <!-- Main Viewer -->
            <div class="grid lg:grid-cols-3 gap-6">
                <!-- Image with AI Overlay -->
                <div class="lg:col-span-2 glass rounded-2xl p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold">AI Visualization</h3>
                        <div class="flex space-x-2">
                            <button onclick="setOverlay('none')" class="px-3 py-1 rounded-lg bg-white/5 text-xs hover:bg-white/10">Original</button>
                            <button onclick="setOverlay('heatmap')" class="px-3 py-1 rounded-lg bg-red-500/20 text-red-400 text-xs">Heatmap</button>
                            <button onclick="setOverlay('segmentation')" class="px-3 py-1 rounded-lg bg-blue-500/20 text-blue-400 text-xs">Segmentation</button>
                        </div>
                    </div>
                    <div class="relative rounded-xl overflow-hidden bg-black">
                        <img id="xrayImage" class="w-full">
                        <canvas id="aiOverlay" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
                        <div id="scanningEffect" class="absolute inset-0 hidden">
                            <div class="scan-line absolute left-0 right-0 h-1 bg-cyan-400 shadow-[0_0_20px_rgba(34,211,238,0.8)]"></div>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Panel -->
                <div class="space-y-4">
                    <!-- Confidence Score -->
                    <div class="glass rounded-2xl p-4">
                        <h4 class="text-sm font-medium text-gray-400 mb-2">AI Confidence</h4>
                        <div class="flex items-end space-x-2">
                            <span id="confidenceScore" class="text-4xl font-bold text-green-400">--</span>
                            <span class="text-sm text-gray-400 mb-1">%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                            <div id="confidenceBar" class="bg-green-500 h-2 rounded-full confidence-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Findings Summary -->
                    <div class="glass rounded-2xl p-4">
                        <h4 class="text-sm font-medium text-gray-400 mb-3">Detections</h4>
                        <div id="findingsSummary" class="space-y-2">
                            <!-- Dynamic content -->
                        </div>
                    </div>

                    <!-- Risk Assessment -->
                    <div class="glass rounded-2xl p-4">
                        <h4 class="text-sm font-medium text-gray-400 mb-3">Risk Assessment</h4>
                        <canvas id="riskChart" width="200" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Report -->
            <div class="glass rounded-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Clinical Report</h3>
                    <button onclick="downloadReport()" class="px-4 py-2 bg-blue-600 rounded-lg text-sm hover:bg-blue-700">
                        ðŸ“„ Download PDF
                    </button>
                </div>
                
                <div id="clinicalReport" class="prose prose-invert max-w-none">
                    <!-- AI-generated report -->
                </div>
            </div>

            <!-- Comparison Table -->
            <div class="glass rounded-2xl p-6">
                <h3 class="text-xl font-bold mb-4">Differential Diagnosis</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-white/10 text-gray-400 text-sm">
                                <th class="pb-3">Finding</th>
                                <th class="pb-3">Location</th>
                                <th class="pb-3">AI Confidence</th>
                                <th class="pb-3">Differential</th>
                                <th class="pb-3">Recommendation</th>
                            </tr>
                        </thead>
                        <tbody id="diagnosisTable" class="text-sm">
                            <!-- Dynamic rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Advanced AI Analysis System
        const AI_MODELS = {
            mock: {
                name: 'Demo AI',
                analyze: mockAnalysis
            },
            openai: {
                name: 'GPT-4 Vision',
                analyze: openaiAnalysis,
                apiKey: localStorage.getItem('openai_key') || ''
            },
            google: {
                name: 'Google Cloud Vision',
                analyze: googleAnalysis
            },
            pearl: {
                name: 'Pearl AI',
                analyze: pearlAnalysis
            },
            custom: {
                name: 'Custom Endpoint',
                analyze: customAnalysis,
                endpoint: localStorage.getItem('custom_endpoint') || ''
            }
        };

        let currentAnalysis = null;
        let chartInstance = null;

        document.getElementById('fileInput').addEventListener('change', handleUpload);

        async function handleUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (event) => {
                document.getElementById('xrayImage').src = event.target.result;
                document.getElementById('uploadSection').classList.add('hidden');
                document.getElementById('analysisDashboard').classList.remove('hidden');
                
                const provider = document.getElementById('aiProvider').value;
                await runAnalysis(event.target.result, provider);
            };
            reader.readAsDataURL(file);
        }

        async function runAnalysis(imageData, provider) {
            document.getElementById('scanningEffect').classList.remove('hidden');
            
            const model = AI_MODELS[provider];
            const result = await model.analyze(imageData);
            
            document.getElementById('scanningEffect').classList.add('hidden');
            displayResults(result);
        }

        // Mock Analysis (Demo Mode)
        async function mockAnalysis(imageData) {
            // Simulate processing delay
            await new Promise(r => setTimeout(r, 2000));
            
            return {
                confidence: 94.2,
                findings: [
                    {
                        type: 'caries',
                        tooth: '14',
                        surface: 'Mesial',
                        confidence: 0.96,
                        severity: 'moderate',
                        boundingBox: {x: 0.65, y: 0.35, w: 0.08, h: 0.06},
                        description: 'Proximal caries extending into dentin, radiolucency visible',
                        differential: ['Active caries', 'Arrested caries', 'Cervical burnout'],
                        recommendation: 'Bitewing radiograph for confirmation, restoration advised'
                    },
                    {
                        type: 'bone_loss',
                        tooth: '30-31',
                        surface: 'Interproximal',
                        confidence: 0.89,
                        severity: 'mild',
                        boundingBox: {x: 0.75, y: 0.70, w: 0.12, h: 0.04},
                        description: 'Horizontal bone loss approximately 3-4mm from CEJ',
                        differential: ['Chronic periodontitis', 'Aggressive periodontitis'],
                        recommendation: 'Periodontal evaluation, scaling and root planing'
                    },
                    {
                        type: 'periapical_lesion',
                        tooth: '9',
                        surface: 'Apex',
                        confidence: 0.91,
                        severity: 'moderate',
                        boundingBox: {x: 0.50, y: 0.25, w: 0.06, h: 0.08},
                        description: 'Well-circumscribed radiolucency at root apex',
                        differential: ['Radicular cyst', 'Granuloma', 'Abscess'],
                        recommendation: 'Vitality testing, CBCT for 3D evaluation'
                    },
                    {
                        type: 'calculus',
                        tooth: '3-4',
                        surface: 'Buccal',
                        confidence: 0.87,
                        severity: 'mild',
                        boundingBox: {x: 0.25, y: 0.40, w: 0.10, h: 0.03},
                        description: 'Subgingival calculus deposits detected',
                        differential: ['Calculus', 'Restoration overhang'],
                        recommendation: 'Professional cleaning, oral hygiene instruction'
                    }
                ],
                anatomy: {
                    teeth_detected: 28,
                    missing: [1, 16, 17, 32],
                    restorations: 4,
                    implants: 0
                },
                risk_assessment: {
                    caries_risk: 'moderate',
                    periodontal_risk: 'low',
                    endodontic_risk: 'moderate'
                },
                generated_report: `
                    <h4>Radiographic Findings:</h4>
                    <p>Panoramic radiograph reveals mixed dentition with several findings of note. 
                    Tooth #14 demonstrates proximal caries extending into dentin with associated 
                    radiolucency. Periodontal status shows mild horizontal bone loss in posterior 
                    regions. Periapical radiolucency noted at tooth #9 apex suggesting possible 
                    endodontic pathology.</p>
                    
                    <h4>Clinical Correlation:</h4>
                    <p>Findings suggest active dental disease requiring intervention. 
                    Caries risk assessment indicates moderate risk profile. 
                    Patient would benefit from comprehensive treatment planning 
                    including restorative and periodontal management.</p>
                    
                    <h4>Recommendations:</h4>
                    <ol>
                        <li>Clinical examination and vitality testing of tooth #9</li>
                        <li>Bitewing radiographs for caries detection</li>
                        <li>Periodontal charting and treatment</li>
                        <li>Restorative treatment plan for tooth #14</li>
                        <li>6-month recall with bitewing monitoring</li>
                    </ol>
                `
            };
        }

        // Placeholder for real API integrations
        async function openaiAnalysis(imageData) {
            // Requires API key: localStorage.setItem('openai_key', 'your-key')
            const apiKey = AI_MODELS.openai.apiKey;
            if (!apiKey) {
                alert('Please set OpenAI API key in settings');
                return mockAnalysis(imageData);
            }
            // Real OpenAI API call would go here
            return mockAnalysis(imageData);
        }

        async function googleAnalysis(imageData) {
            // Google Cloud Vision API integration
            return mockAnalysis(imageData);
        }

        async function pearlAnalysis(imageData) {
            // Pearl AI enterprise API
            return mockAnalysis(imageData);
        }

        async function customAnalysis(imageData) {
            // Custom endpoint
            return mockAnalysis(imageData);
        }

        function displayResults(result) {
            currentAnalysis = result;
            
            // Confidence
            document.getElementById('confidenceScore').textContent = result.confidence.toFixed(1);
            document.getElementById('confidenceBar').style.width = result.confidence + '%';
            
            // Findings summary
            const findingsDiv = document.getElementById('findingsSummary');
            const grouped = groupBy(result.findings, 'type');
            findingsDiv.innerHTML = Object.entries(grouped).map(([type, items]) => `
                <div class="flex justify-between items-center p-2 bg-white/5 rounded-lg">
                    <span class="capitalize">${type.replace('_', ' ')}</span>
                    <span class="px-2 py-1 rounded-full bg-${getColor(type)}-500/20 text-${getColor(type)}-400 text-xs">
                        ${items.length}
                    </span>
                </div>
            `).join('');
            
            // Draw bounding boxes
            drawBoundingBoxes(result.findings);
            
            // Clinical report
            document.getElementById('clinicalReport').innerHTML = result.generated_report;
            
            // Diagnosis table
            const tableBody = document.getElementById('diagnosisTable');
            tableBody.innerHTML = result.findings.map(f => `
                <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="py-3">
                        <span class="px-2 py-1 rounded bg-${getColor(f.type)}-500/20 text-${getColor(f.type)}-400 text-xs capitalize">
                            ${f.type.replace('_', ' ')}
                        </span>
                    </td>
                    <td class="py-3">Tooth #${f.tooth}<br><span class="text-gray-500 text-xs">${f.surface}</span></td>
                    <td class="py-3">
                        <div class="flex items-center space-x-2">
                            <div class="w-16 bg-gray-700 rounded-full h-1.5">
                                <div class="bg-green-500 h-1.5 rounded-full" style="width: ${f.confidence * 100}%"></div>
                            </div>
                            <span class="text-xs">${(f.confidence * 100).toFixed(0)}%</span>
                        </div>
                    </td>
                    <td class="py-3 text-xs text-gray-400">${f.differential.join(', ')}</td>
                    <td class="py-3 text-xs">${f.recommendation}</td>
                </tr>
            `).join('');
            
            // Risk chart
            drawRiskChart(result.risk_assessment);
        }

        function drawBoundingBoxes(findings) {
            const canvas = document.getElementById('aiOverlay');
            const ctx = canvas.getContext('2d');
            const img = document.getElementById('xrayImage');
            
            canvas.width = img.offsetWidth;
            canvas.height = img.offsetHeight;
            
            findings.forEach(f => {
                const x = f.boundingBox.x * canvas.width;
                const y = f.boundingBox.y * canvas.height;
                const w = f.boundingBox.w * canvas.width;
                const h = f.boundingBox.h * canvas.height;
                
                ctx.strokeStyle = getColorHex(f.type);
                ctx.lineWidth = 3;
                ctx.strokeRect(x, y, w, h);
                
                ctx.fillStyle = getColorHex(f.type) + '40';
                ctx.fillRect(x, y, w, h);
                
                ctx.fillStyle = getColorHex(f.type);
                ctx.font = 'bold 14px Inter';
                ctx.fillText(`${f.tooth} (${(f.confidence * 100).toFixed(0)}%)`, x, y - 5);
            });
        }

        function drawRiskChart(risk) {
            const ctx = document.getElementById('riskChart').getContext('2d');
            
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Caries', 'Periodontal', 'Endodontic', 'Prosthodontic', 'Orthodontic'],
                    datasets: [{
                        label: 'Risk Level',
                        data: [3, 2, 3, 1, 2], // 1-5 scale
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3b82f6',
                        pointBackgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 5,
                            ticks: { display: false }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function setOverlay(type) {
            const canvas = document.getElementById('aiOverlay');
            if (type === 'none') {
                canvas.style.opacity = '0';
            } else {
                canvas.style.opacity = '1';
                // Would switch between different AI visualizations
            }
        }

        function downloadReport() {
            if (!currentAnalysis) return;
            
            const report = `
DENTAL AI ANALYSIS REPORT
========================
Date: ${new Date().toLocaleString()}
AI Confidence: ${currentAnalysis.confidence}%

FINDINGS:
${currentAnalysis.findings.map(f => `- ${f.type.toUpperCase()}: Tooth #${f.tooth} (${f.surface}) - ${f.description}`).join('\n')}

RECOMMENDATIONS:
1. Clinical correlation advised
2. Follow-up imaging as indicated
3. Referral to specialist if needed
            `;
            
            const blob = new Blob([report], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dental-report-${Date.now()}.txt`;
            a.click();
        }

        function groupBy(arr, key) {
            return arr.reduce((acc, item) => {
                (acc[item[key]] = acc[item[key]] || []).push(item);
                return acc;
            }, {});
        }

        function getColor(type) {
            const colors = {
                caries: 'red',
                bone_loss: 'yellow',
                periapical_lesion: 'purple',
                calculus: 'blue',
                fracture: 'orange',
                impaction: 'pink'
            };
            return colors[type] || 'gray';
        }

        function getColorHex(type) {
            const colors = {
                caries: '#ef4444',
                bone_loss: '#eab308',
                periapical_lesion: '#a855f7',
                calculus: '#3b82f6',
                fracture: '#f97316',
                impaction: '#ec4899'
            };
            return colors[type] || '#6b7280';
        }
    </script>
</body>
</html>
